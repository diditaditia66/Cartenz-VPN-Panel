<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cartenz VPN Premium</title>
<style>
  :root{
    --bg:#0b1117;--panel:#0f1724;--panel2:#0d1520;--ink:#e6edf3;--muted:#96a3b4;
    --line:#1f2b3a;--accent:#66b2ff;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  a{color:inherit;text-decoration:none}
  .container{max-width:1050px;margin:0 auto;padding:20px}
  /* cards & controls */
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
  .card.flat{background:transparent;border-color:transparent}
  .title{font-weight:700;font-size:18px;margin-bottom:8px}
  .sub{color:var(--muted);font-size:13px;margin-bottom:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .grid{display:grid;gap:14px}
  .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width: 900px){.grid.cols-3{grid-template-columns:1fr}}
  .input{background:var(--panel2);border:1px solid var(--line);border-radius:12px;color:var(--ink);padding:10px 12px;min-width:160px;outline:none}
  .input:focus{border-color:var(--accent)}
  .btn{appearance:none;border:1px solid var(--line);background:#132033;color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer}
  .btn:hover{border-color:var(--accent)}
  .btn.primary{background:#183053;border-color:#294268}
  .btn.ok{background:#0f2a1c;border-color:#1d6d45}
  .btn.warn{background:#2f250e;border-color:#6c5321}
  .btn.err{background:#3a1f24;border-color:#6e3039}
  .btn.ghost{background:transparent}
  .btn.big{padding:16px 18px;font-size:15px;border-radius:16px}
  .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:6px 12px;background:#121b29}
  .muted{color:var(--muted)}
  .spacer{height:14px}
  .hr{height:1px;background:var(--line);margin:14px 0}
  .right{margin-left:auto}
  /* layout screens */
  .screen{display:none}
  .screen.active{display:block}
  /* topbar */
  .topbar{display:flex;gap:10px;align-items:center;margin-bottom:16px}
  .topbar h1{font-size:22px;margin:0}
  /* terminal */
  .terminal{background:#0a1016;border:1px solid var(--line);border-radius:14px;padding:12px;min-height:220px;white-space:pre-wrap;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace}
  .toolbar{display:flex;gap:8px;justify-content:flex-end;margin-bottom:8px}
  /* menu tiles */
  .tile{display:flex;gap:12px;align-items:flex-start;border:1px solid var(--line);background:#0e1623;border-radius:16px;padding:16px;cursor:pointer}
  .tile:hover{border-color:var(--accent)}
  .tile .icon{width:36px;height:36px;border-radius:10px;background:#152236;display:flex;align-items:center;justify-content:center}
  .tile h3{margin:0 0 4px 0}
  /* tab selector */
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#0e1623;color:#c6d3e3;cursor:pointer}
  .tab.active{background:#17263b;border-color:#294268;color:#fff}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left;font-size:13px}
  th{color:#b9c6d8}
  /* fullscreen login */
  .login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
  .login-card{max-width:420px;width:100%}
  .hidden{ display:none !important; }
  /* modal sederhana */
  .modal-wrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:50;padding:16px;}
  .modal-wrap.open{display:flex;}
  .modal-card{width:100%;max-width:420px;background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.4);}
  .modal-header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
  .modal-header h3{margin:0;font-size:18px}
  .modal-footer{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
</style>
</head>
<body>

<!-- ========== LOGIN ========== -->
<section id="scr-login" class="screen active">
  <div class="login-wrap">
    <div class="card login-card">
      <div class="title">Masuk ke Cartenz VPN Premium</div>
      <div class="sub">Silakan login terlebih dahulu untuk melanjutkan.</div>
      <div class="row">
        <input id="lg-user" class="input" placeholder="username" autocomplete="username">
        <input id="lg-pass" class="input" placeholder="password" type="password" autocomplete="current-password">
      </div>
      <div class="spacer"></div>
      <div class="row">
        <button id="btnLogin" class="btn primary">Login</button>
        <span id="loginMsg" class="muted"></span>
      </div>
    </div>
  </div>
</section>

<!-- ========== HOME ========== -->
<section id="scr-home" class="screen">
  <div class="container">
    <div class="topbar">
      <h1>Cartenz VPN Premium</h1>
      <span id="whoami" class="pill">‚Äî</span>
      <span id="saldo" class="pill">Saldo: Rp 0</span>
      <a class="btn ghost" href="https://t.me/Cartenz_VPN" target="_blank" rel="noopener">Top Up via Telegram</a>
      <span class="right"></span>
      <button id="btnGoAdmin" class="btn">Admin</button>
      <button id="btnGoManage" class="btn">Manage</button>
      <button id="btnGoAdd" class="btn ok">Add</button>
      <button id="btnGoTrial" class="btn warn">Trial</button>
      <button id="btnChangePwd" class="btn">Ganti Password</button>
      <button id="btnLogout" class="btn err">Logout</button>
    </div>

    <div class="grid cols-3">
      <div id="go-add" class="tile">
        <div class="icon">‚ûï</div>
        <div><h3>Add Account</h3><div class="muted">Buat akun SSH/VMess/VLess/Trojan/SS.</div></div>
      </div>
      <div id="go-trial" class="tile">
        <div class="icon">‚ö°</div>
        <div><h3>Trial Account</h3><div class="muted">Buat trial 1 hari (dibatasi 1√ó/hari).</div></div>
      </div>
      <div id="go-manage" class="tile">
        <div class="icon">üõ†Ô∏è</div>
        <div><h3>Manage (Admin)</h3><div class="muted">Lihat & hapus akun per layanan.</div></div>
      </div>
    </div>

    <div class="spacer"></div>

    <div class="card">
      <div class="row">
        <div class="title">Output</div>
        <span class="right"></span>
        <div class="toolbar">
          <button id="btnCopy" class="btn ghost">üìã Salin</button>
          <button id="btnClear" class="btn ghost">üßπ Bersihkan</button>
        </div>
      </div>
      <pre id="out" class="terminal"></pre>
    </div>
  </div>
</section>

<!-- ========== ADD ========== -->
<section id="scr-add" class="screen">
  <div class="container">
    <div class="topbar">
      <button class="btn" id="backHomeA">‚Üê Kembali</button>
      <h1>Tambah Akun</h1>
      <span class="right"></span>
      <button id="btnToTrialFromAdd" class="btn warn">Trial</button>
      <button id="btnToManageFromAdd" class="btn">Manage</button>
    </div>

    <div class="card flat">
      <div class="sub">Pilih layanan:</div>
      <div class="tabs" id="addTabs">
        <button class="tab active" data-kind="ssh">SSH</button>
        <button class="tab" data-kind="vmess">VMess</button>
        <button class="tab" data-kind="vless">VLess</button>
        <button class="tab" data-kind="trojan">Trojan</button>
        <button class="tab" data-kind="ss">Shadowsocks</button>
      </div>

      <!-- SSH form -->
      <div id="add-ssh" class="card">
        <div class="title">Add SSH</div>
        <div class="row">
          <input id="ssh_user" class="input" placeholder="username">
          <input id="ssh_pass" class="input" placeholder="password (kosong = auto)">
          <input id="ssh_days" class="input" type="number" min="1" value="30">
          <button id="btnAddSSH" class="btn ok" disabled>Tambah</button>
        </div>
        <div class="sub">Tombol akan aktif jika username terisi.</div>
      </div>

      <!-- Generic form -->
      <div id="add-generic" class="card hidden">
        <div class="title" id="genTitle">Add VMess</div>
        <div class="row">
          <input id="gen_remarks" class="input" placeholder="remarks / username">
          <input id="gen_days" class="input" type="number" min="1" value="30">
          <button id="btnAddGeneric" class="btn ok" disabled>Tambah</button>
        </div>
      </div>

      <div class="spacer"></div>
      <div class="card">
        <div class="row">
          <div class="title">Output</div>
          <span class="right"></span>
          <div class="toolbar">
            <button id="btnCopyA" class="btn ghost">üìã Salin</button>
            <button id="btnClearA" class="btn ghost">üßπ Bersihkan</button>
          </div>
        </div>
        <pre id="outA" class="terminal"></pre>
      </div>
    </div>
  </div>
</section>

<!-- ========== TRIAL ========== -->
<section id="scr-trial" class="screen">
  <div class="container">
    <div class="topbar">
      <button class="btn" id="backHomeT">‚Üê Kembali</button>
      <h1>Trial Akun</h1>
      <span class="right"></span>
      <button id="btnToAddFromTrial" class="btn ok">Add</button>
      <button id="btnToManageFromTrial" class="btn">Manage</button>
    </div>

    <div class="card flat">
      <div class="sub">Pilih layanan trial:</div>
      <div class="tabs" id="trialTabs">
        <button class="tab active" data-kind="ssh">SSH</button>
        <button class="tab" data-kind="vmess">VMess</button>
        <button class="tab" data-kind="vless">VLess</button>
        <button class="tab" data-kind="trojan">Trojan</button>
        <button class="tab" data-kind="ss">Shadowsocks</button>
      </div>
      <button id="btnDoTrial" class="btn warn big">Buat Trial</button>

      <div class="spacer"></div>
      <div class="card">
        <div class="row">
          <div class="title">Output</div>
          <span class="right"></span>
          <div class="toolbar">
            <button id="btnCopyT" class="btn ghost">üìã Salin</button>
            <button id="btnClearT" class="btn ghost">üßπ Bersihkan</button>
          </div>
        </div>
        <pre id="outT" class="terminal"></pre>
      </div>
    </div>
  </div>
</section>

<!-- ========== MANAGE (ADMIN) ========== -->
<section id="scr-manage" class="screen">
  <div class="container">
    <div class="topbar">
      <button class="btn" id="backHomeM">‚Üê Kembali</button>
      <h1>Manage Akun</h1>
      <span class="right"></span>
      <button id="btnToAddFromManage" class="btn ok">Add</button>
      <button id="btnToTrialFromManage" class="btn warn">Trial</button>
    </div>

    <div class="card flat">
      <div class="sub">Pilih layanan untuk melihat daftarnya:</div>
      <div class="tabs" id="manTabs">
        <button class="tab active" data-kind="ssh">SSH</button>
        <button class="tab" data-kind="vmess">VMess</button>
        <button class="tab" data-kind="vless">VLess</button>
        <button class="tab" data-kind="trojan">Trojan</button>
        <button class="tab" data-kind="ss">Shadowsocks</button>
        <span class="right pill" id="refTime">‚Äî</span>
      </div>

      <div id="tblWrap" class="card">
        <table id="tbl"><thead><tr><th>Nama</th><th>Expired</th><th>Aksi</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>
</section>

<!-- ========== ADMIN PANEL (Create User & Add Balance) ========== -->
<section id="scr-admin" class="screen">
  <div class="container">
    <div class="topbar">
      <button class="btn" id="backHomeAdmin">‚Üê Kembali</button>
      <h1>Admin Panel</h1>
      <span class="right"></span>
      <button id="btnRefreshUsers" class="btn">Refresh</button>
    </div>

    <div class="grid cols-3">
      <!-- Create User -->
      <div class="card">
        <div class="title">Create User</div>
        <div class="row">
          <input id="adm_new_user" class="input" placeholder="username">
          <input id="adm_new_pass" class="input" placeholder="password (kosong=changeme123)">
          <select id="adm_new_role" class="input">
            <option value="user">user</option>
            <option value="admin">admin</option>
          </select>
          <input id="adm_new_balance" class="input" type="number" placeholder="saldo awal (Rp)" value="0" min="0">
        </div>
        <div class="spacer"></div>
        <button id="adm_btn_create" class="btn ok">Buat User</button>
        <div id="adm_create_msg" class="sub"></div>
      </div>

      <!-- Add Balance -->
      <div class="card">
        <div class="title">Add Balance</div>
        <div class="row">
          <input id="adm_bal_user" class="input" placeholder="username">
          <input id="adm_bal_amount" class="input" type="number" placeholder="jumlah (Rp)" value="10000" min="1">
        </div>
        <div class="spacer"></div>
        <button id="adm_btn_addbal" class="btn ok">Tambah Saldo</button>
        <div id="adm_bal_msg" class="sub"></div>
      </div>

      <!-- Users Table -->
      <div class="card">
        <div class="title">Daftar User</div>
        <div class="sub">Berisi username, role, saldo, dan last trial.</div>
        <div class="hr"></div>
        <table id="adm_tbl_users">
          <thead><tr><th>Username</th><th>Role</th><th>Saldo (Rp)</th><th>Last Trial</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<!-- ===== MODAL GANTI PASSWORD ===== -->
<div id="modalPwd" class="modal-wrap" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="pwdTitle">
    <div class="modal-header">
      <h3 id="pwdTitle">Ganti Password</h3>
      <span class="right"></span>
      <button id="pwdClose" class="btn ghost" aria-label="Tutup">‚úï</button>
    </div>
    <div class="row">
      <input id="oldPwd" class="input" type="password" placeholder="Password lama" autocomplete="current-password">
      <input id="newPwd" class="input" type="password" placeholder="Password baru (min 6)" autocomplete="new-password">
      <input id="newPwd2" class="input" type="password" placeholder="Ulangi password baru" autocomplete="new-password">
    </div>
    <div class="modal-footer">
      <button id="pwdCancel" class="btn">Batal</button>
      <button id="pwdSave" class="btn ok">Simpan</button>
    </div>
    <div id="pwdMsg" class="sub muted"></div>
  </div>
</div>

<script>
  // ==== helpers ====
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const screens = {
    login: $("#scr-login"), home: $("#scr-home"),
    add: $("#scr-add"), trial: $("#scr-trial"),
    manage: $("#scr-manage"), admin: $("#scr-admin")
  };
  function show(name){
    Object.values(screens).forEach(sc=>sc.classList.remove("active"));
    screens[name].classList.add("active");
    window.scrollTo({top:0,behavior:"instant"});
  }
  const out = $("#out"), outA=$("#outA"), outT=$("#outT");
  function log(outEl, s){ outEl.textContent += (outEl.textContent && !outEl.textContent.endsWith("\\n") ? "\\n":"") + s; outEl.scrollTop=outEl.scrollHeight; }
  function clearOut(outEl){ outEl.textContent=""; }
  function copyOut(outEl){ navigator.clipboard.writeText(outEl.textContent||""); }
  async function api(url,opt={}){
    const res = await fetch(url,{credentials:"same-origin",headers:{"Content-Type":"application/json"},...opt});
    const data = await res.json().catch(()=> ({}));
    if(!res.ok) throw new Error(data.error||res.statusText||"Request failed");
    return data;
  }
  const esc = s => (s||"").replace(/[&<>\"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;' }[c]));
  const escAttr = s => (s||\"\").replace(/\"/g,'&quot;');

  // ==== state / UI helpers ====
  let CURRENT_USER = null;
  function setWhoAndUI(user){
    CURRENT_USER = user;
    $("#whoami").textContent = `Login: ${user.username} (${user.role})`;
    $("#saldo").textContent = `Saldo: Rp ${Number(user.balance||0).toLocaleString("id-ID")}`;
    const isAdmin = (user.role === "admin");
    // tampil/hidden tombol & tile admin/manage
    $("#btnGoAdmin").style.display = isAdmin ? "" : "none";
    $("#btnGoManage").style.display = isAdmin ? "" : "none";
    const manageTile = $("#go-manage");
    if (manageTile) manageTile.style.display = isAdmin ? "" : "none";
  }
  function updateSaldoBadge(amount){
    const el = $("#saldo");
    if (!el) return;
    const n = Number(amount||0);
    el.textContent = `Saldo: Rp ${n.toLocaleString("id-ID")}`;
  }

  // ==== auth flow ====
  async function boot(){
    try{
      const m = await api("/api/me",{method:"GET"});
      if(m.user){ setWhoAndUI(m.user); show("home"); }
      else show("login");
    }catch{ show("login"); }
  }
  $("#btnLogin").onclick = async ()=>{
    $("#loginMsg").textContent="";
    try{
      const username = $("#lg-user").value.trim();
      const password = $("#lg-pass").value;
      const r = await api("/api/login",{method:"POST",body:JSON.stringify({username,password})});
      setWhoAndUI(r.user); show("home");
    }catch(e){ $("#loginMsg").textContent = "‚ùå " + e.message; }
  };
  $("#btnLogout").onclick = async ()=>{
    try{ await api("/api/logout",{method:"POST"}); show("login"); }
    catch(e){ alert(e.message); }
  };

  // ==== home nav ====
  $("#go-add").onclick = ()=> show("add");
  $("#go-trial").onclick = ()=> show("trial");
  $("#go-manage").onclick = ()=> { show("manage"); refreshManage(); };
  $("#btnGoAdd").onclick = ()=> show("add");
  $("#btnGoTrial").onclick = ()=> show("trial");
  $("#btnGoManage").onclick = ()=> { show("manage"); refreshManage(); };
  $("#btnGoAdmin").onclick = ()=> { show("admin"); refreshUsers(); };

  // back buttons + cross nav
  $("#backHomeA").onclick = ()=> show("home");
  $("#backHomeT").onclick = ()=> show("home");
  $("#backHomeM").onclick = ()=> show("home");
  $("#backHomeAdmin").onclick = ()=> show("home");
  $("#btnToTrialFromAdd").onclick = ()=> show("trial");
  $("#btnToManageFromAdd").onclick = ()=> { show("manage"); refreshManage(); };
  $("#btnToAddFromTrial").onclick = ()=> show("add");
  $("#btnToManageFromTrial").onclick = ()=> { show("manage"); refreshManage(); };
  $("#btnToAddFromManage").onclick = ()=> show("add");
  $("#btnToTrialFromManage").onclick = ()=> show("trial");

  // terminal toolbar
  $("#btnCopy").onclick = ()=> copyOut(out);
  $("#btnClear").onclick = ()=> clearOut(out);
  $("#btnCopyA").onclick = ()=> copyOut(outA);
  $("#btnClearA").onclick = ()=> clearOut(outA);
  $("#btnCopyT").onclick = ()=> copyOut(outT);
  $("#btnClearT").onclick = ()=> clearOut(outT);

  // ==== ADD screen ====
  let addKind = "ssh";
  function setAddKind(k){
    addKind = k;
    $$("#addTabs .tab").forEach(t=>t.classList.toggle("active", t.dataset.kind===k));
    if(k==="ssh"){
      $("#add-ssh").classList.remove("hidden");
      $("#add-generic").classList.add("hidden");
    }else{
      $("#add-ssh").classList.add("hidden");
      $("#add-generic").classList.remove("hidden");
      $("#genTitle").textContent = "Add " + k.toUpperCase();
    }
    validateAdd();
  }
  $$("#addTabs .tab").forEach(t=> t.onclick=()=> setAddKind(t.dataset.kind));
  function validateAdd(){
    const sshOk = $("#ssh_user").value.trim().length>0;
    $("#btnAddSSH").disabled = !sshOk;
    const genOk = $("#gen_remarks").value.trim().length>0;
    $("#btnAddGeneric").disabled = !genOk;
  }
  $("#ssh_user").oninput = validateAdd;
  $("#gen_remarks").oninput = validateAdd;

  $("#btnAddSSH").onclick = async ()=>{
    const username = $("#ssh_user").value.trim();
    const password = $("#ssh_pass").value;
    const days = parseInt($("#ssh_days").value||"30",10);
    log(outA, `$ add ssh ${username} ${days}d ...`);
    try{
      const {output,generatedPassword,balance} = await api("/api/add/ssh",{method:"POST",body:JSON.stringify({username,password,days})});
      log(outA, output||"(no output)");
      if(generatedPassword) log(outA, `Password (auto): ${generatedPassword}`);
      if (balance !== undefined) updateSaldoBadge(balance);
      refreshManageIfVisible();
    }catch(e){ log(outA, "ERROR: "+e.message); }
  };

  $("#btnAddGeneric").onclick = async ()=>{
    const remarks = $("#gen_remarks").value.trim();
    const days = parseInt($("#gen_days").value||"30",10);
    log(outA, `$ add ${addKind} ${remarks} ${days}d ...`);
    try{
      const {output,balance} = await api(`/api/add/${addKind}`,{method:"POST",body:JSON.stringify({remarks,days})});
      log(outA, output||"(no output)");
      if (balance !== undefined) updateSaldoBadge(balance);
      refreshManageIfVisible();
    }catch(e){ log(outA, "ERROR: "+e.message); }
  };

  // ==== TRIAL screen ====
  let trialKind = "ssh";
  function setTrialKind(k){
    trialKind = k;
    $$("#trialTabs .tab").forEach(t=>t.classList.toggle("active", t.dataset.kind===k));
  }
  $$("#trialTabs .tab").forEach(t=> t.onclick=()=> setTrialKind(t.dataset.kind));
  $("#btnDoTrial").onclick = async ()=>{
    log(outT, `$ trial ${trialKind} ...`);
   try{
      const {output} = await api(`/api/trial/${trialKind}`,{method:"POST"});
      log(outT, output||"(no output)");
      refreshManageIfVisible();
    }catch(e){ log(outT, "ERROR: "+e.message); }
  };

  // ==== MANAGE screen (ADMIN) ====
  let manKind = "ssh";
  function setManKind(k){
    manKind = k;
    $$("#manTabs .tab").forEach(t=>t.classList.toggle("active", t.dataset.kind===k));
    refreshManage();
  }
  $$("#manTabs .tab").forEach(t=> t.onclick=()=> setManKind(t.dataset.kind));

  async function refreshManage(){
    try{
      const data = await api("/api/accounts",{method:"GET"});
      const map = {ssh:"ssh",vmess:"vmess",vless:"vless",trojan:"trojan",ss:"ss"};
      const rows = data[map[manKind]] || [];
      const tb = $("#tbl tbody"); tb.innerHTML="";
      if(!rows.length){
        const tr=document.createElement("tr"); tr.innerHTML=`<td class="muted" colspan="3">Tidak ada data</td>`;
        tb.appendChild(tr);
      }else{
        rows.forEach(r=>{
          const name = r.username || r.user || "";
          const tr=document.createElement("tr");
          tr.innerHTML = `<td>${esc(name)}</td><td>${esc(r.exp||"-")}</td>
            <td><button class="btn err" data-del="${escAttr(name)}">Hapus</button></td>`;
          tb.appendChild(tr);
        });
      }
      $("#refTime").textContent = "Refreshed " + new Date().toLocaleTimeString();
      tb.querySelectorAll("[data-del]").forEach(b=>{
        b.onclick = async ()=>{
          const name = b.dataset.del;
          if(!confirm(\`Hapus \${manKind} \${name}?\`)) return;
          try{
            const res = await api(\`/api/accounts/\${encodeURIComponent(manKind)}/\${encodeURIComponent(name)}\`,{method:"DELETE"});
            alert("OK: " + (res.output||"deleted"));
            refreshManage();
          }catch(e){ alert(e.message); }
        };
      });
    }catch(e){
      alert("Gagal load accounts: " + e.message);
    }
  }
  function refreshManageIfVisible(){ if(screens.manage.classList.contains("active")) refreshManage(); }

  // ==== ADMIN PANEL ====
  async function refreshUsers(){
    try{
      const r = await api("/api/admin/users",{method:"GET"});
      const tb = $("#adm_tbl_users tbody"); tb.innerHTML = "";
      (r.users||[]).forEach(u=>{
        const tr = document.createElement("tr");
        tr.innerHTML = \`<td>\${esc(u.username)}</td><td>\${esc(u.role)}</td><td>\${Number(u.balance||0).toLocaleString("id-ID")}</td><td>\${esc(u.lastTrialDate||"-")}</td>\`;
        tb.appendChild(tr);
      });
    }catch(e){
      const tb = $("#adm_tbl_users tbody");
      tb.innerHTML = \`<tr><td colspan="4" class="muted">Gagal memuat daftar user: \${esc(e.message)}</td></tr>\`;
    }
  }
  $("#btnRefreshUsers").onclick = refreshUsers;
  $("#adm_btn_create").onclick = async ()=>{
    const username = $("#adm_new_user").value.trim();
    const password = $("#adm_new_pass").value;
    const role = $("#adm_new_role").value;
    const balance = Number($("#adm_new_balance").value||0);
    const msg = $("#adm_create_msg"); msg.textContent = "";
    if(!username) return msg.textContent = "‚ùå username wajib diisi";
    try{
      await api("/api/admin/create-user",{method:"POST",body:JSON.stringify({username,password,role,balance})});
      msg.textContent = "‚úÖ User dibuat";
      refreshUsers();
    }catch(e){ msg.textContent = "‚ùå " + e.message; }
  };
  $("#adm_btn_addbal").onclick = async ()=>{
    const username = $("#adm_bal_user").value.trim();
    const amount = Number($("#adm_bal_amount").value||0);
    const msg = $("#adm_bal_msg"); msg.textContent = "";
    if(!username || !amount) return msg.textContent = "‚ùå username & amount wajib diisi";
    try{
      const r = await api("/api/admin/add-balance",{method:"POST",body:JSON.stringify({username,amount})});
      msg.textContent = "‚úÖ Saldo user sekarang: Rp " + Number(r.balance||0).toLocaleString("id-ID");
      // Jika admin menambah saldo dirinya sendiri, update badge
      if (CURRENT_USER && CURRENT_USER.username === username) updateSaldoBadge(r.balance);
      refreshUsers();
    }catch(e){ msg.textContent = "‚ùå " + e.message; }
  };

  // ==== GANTI PASSWORD ====
  const modalPwd = $("#modalPwd");
  const btnChangePwd = $("#btnChangePwd");
  const btnPwdClose = $("#pwdClose");
  const btnPwdCancel = $("#pwdCancel");
  const btnPwdSave = $("#pwdSave");
  const oldPwd = $("#oldPwd");
  const newPwd = $("#newPwd");
  const newPwd2 = $("#newPwd2");
  const pwdMsg = $("#pwdMsg");
  function openPwd(){ modalPwd.classList.add("open"); oldPwd.focus(); pwdMsg.textContent=""; }
  function closePwd(){ modalPwd.classList.remove("open"); oldPwd.value=""; newPwd.value=""; newPwd2.value=""; pwdMsg.textContent=""; }
  btnChangePwd.onclick = openPwd;
  btnPwdClose.onclick = closePwd;
  btnPwdCancel.onclick = closePwd;
  btnPwdSave.onclick = async ()=>{
    pwdMsg.textContent = "";
    const o = oldPwd.value;
    const n1 = newPwd.value;
    const n2 = newPwd2.value;
    if(!o) return pwdMsg.textContent = "‚ùå Password lama wajib diisi";
    if(n1.length < 6) return pwdMsg.textContent = "‚ùå Password baru minimal 6 karakter";
    if(n1 !== n2) return pwdMsg.textContent = "‚ùå Ulangi password baru tidak sama";
    try{
      await api("/api/change-password",{method:"POST",body:JSON.stringify({oldPassword:o,newPassword:n1})});
      pwdMsg.textContent = "‚úÖ Password berhasil diganti";
      setTimeout(closePwd, 800);
    }catch(e){
      pwdMsg.textContent = "‚ùå " + e.message;
    }
  };

  // bootstrap
  boot();
</script>
</body>
</html>
